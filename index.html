<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MusicGrid</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: #111;
      color: white;
    }
    .screen {
      display: none;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    #home-screen, #editor-screen {
      min-height: 100vh;
      width: 100vw;
    }
    #home-screen {
      display: flex;
    }
    h1 {
      font-size: 3rem;
    }
    #grid {
      display: grid;
      grid-template-columns: repeat(18, 40px);
      grid-template-rows: repeat(18, 40px);
      gap: 2px;
      margin: 10px 0;
    }
    .cell {
      background: #333;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      font-size: 10px;
    }
    .note-in-cell {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s, filter 0.2s;
    }
    .note-playing {
      transform: scale(1.5);
      filter: brightness(1.8);
      z-index: 1;
    }
    #controls {
      margin-top: 10px;
    }
    .note-btn, #delete-tool {
      border: 2px solid transparent;
      margin: 3px;
      padding: 5px;
      cursor: pointer;
      background: #222;
      color: white;
      min-width: 40px;
    }
    .selected {
      border-color: green;
    }
    #playhead {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 2px;
      background: red;
      z-index: 10;
    }
    #note-palette {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      max-width: 800px;
    }
    button {
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div id="home-screen" class="screen">
    <h1>üéµ MusicGrid üéµ</h1>
    <form id="new-song-form">
      <input id="new-song-name" placeholder="Enter song name" required />
      <button type="submit">New Song</button>
    </form>
    <h3>My Songs</h3>
    <ul id="song-list"></ul>
  </div>

  <div id="editor-screen" class="screen">
    <div id="note-palette"></div>
    <button id="delete-tool">Delete</button>
    <div id="grid-container" style="position:relative;">
      <div id="grid"></div>
      <div id="playhead"></div>
    </div>
    <div id="controls">
      <button id="play-btn">‚ñ∂Ô∏è Play</button>
      <button id="stop-btn">‚èπÔ∏è Stop</button>
      <button id="back-home-btn">üè† Home</button>
    </div>
  </div>

  <script>
    const notes = [
      { name: "C3", freq: 130.81, color: "#e74c3c" },
      { name: "C#3", freq: 138.59, color: "#9b59b6" },
      { name: "D3", freq: 146.83, color: "#2980b9" },
      { name: "D#3", freq: 155.56, color: "#1abc9c" },
      { name: "E3", freq: 164.81, color: "#27ae60" },
      { name: "F3", freq: 174.61, color: "#f39c12" },
      { name: "F#3", freq: 185.00, color: "#d35400" },
      { name: "G3", freq: 196.00, color: "#c0392b" },
      { name: "G#3", freq: 207.65, color: "#7f8c8d" },
      { name: "A3", freq: 220.00, color: "#3498db" },
      { name: "A#3", freq: 233.08, color: "#2ecc71" },
      { name: "B3", freq: 246.94, color: "#f1c40f" },
      { name: "C4", freq: 261.63, color: "#e67e22" },
      { name: "D4", freq: 293.66, color: "#16a085" },
      { name: "E4", freq: 329.63, color: "#8e44ad" },
      { name: "F4", freq: 349.23, color: "#34495e" },
      { name: "G4", freq: 392.00, color: "#bdc3c7" },
      { name: "A4", freq: 440.00, color: "#95a5a6" }
    ];

    const gridSize = 18;
    const grid = document.getElementById("grid");
    const playBtn = document.getElementById("play-btn");
    const stopBtn = document.getElementById("stop-btn");
    const notePalette = document.getElementById("note-palette");
    const deleteToolBtn = document.getElementById("delete-tool");
    const playhead = document.getElementById("playhead");

    let selectedNoteIndex = null;
    let gridNotes = new Array(gridSize * gridSize).fill(null);
    let currentSongName = null;
    let audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let playInterval = null;
    let playCol = 0;

    function createNoteButtons() {
      notePalette.innerHTML = "";
      notes.forEach((note, i) => {
        const btn = document.createElement("button");
        btn.className = "note-btn";
        btn.style.backgroundColor = note.color;
        btn.textContent = note.name;
        btn.addEventListener("click", () => {
          selectedNoteIndex = i;
          updateSelectedNoteUI();
        });
        notePalette.appendChild(btn);
      });
    }

    function updateSelectedNoteUI() {
      document.querySelectorAll(".note-btn").forEach((btn, i) => {
        btn.classList.toggle("selected", i === selectedNoteIndex);
      });
      deleteToolBtn.classList.toggle("selected", selectedNoteIndex === "delete");
    }

    function createGrid() {
      grid.innerHTML = "";
      grid.style.gridTemplateColumns = `repeat(${gridSize}, 40px)`;
      grid.style.gridTemplateRows = `repeat(${gridSize}, 40px)`;
      for (let i = 0; i < gridSize * gridSize; i++) {
        const cell = document.createElement("div");
        cell.className = "cell";
        const noteDiv = document.createElement("div");
        noteDiv.className = "note-in-cell";
        cell.appendChild(noteDiv);
        cell.addEventListener("click", () => {
          if (selectedNoteIndex === "delete") {
            gridNotes[i] = null;
          } else if (selectedNoteIndex !== null) {
            gridNotes[i] = selectedNoteIndex;
          }
          updateGridFromNotes();
        });
        grid.appendChild(cell);
      }
      updateGridFromNotes();
    }

    function updateGridFromNotes() {
      const cells = Array.from(grid.children);
      for (let i = 0; i < gridNotes.length; i++) {
        const noteDiv = cells[i].querySelector(".note-in-cell");
        const noteIdx = gridNotes[i];
        if (noteIdx === null) {
          noteDiv.style.backgroundColor = "";
          noteDiv.textContent = "";
        } else {
          noteDiv.style.backgroundColor = notes[noteIdx].color;
          noteDiv.textContent = notes[noteIdx].name;
        }
        noteDiv.classList.remove("note-playing");
      }
    }

    function playNote(frequency) {
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = "sine";
      osc.frequency.value = frequency;
      gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.5);
      osc.connect(gain).connect(audioCtx.destination);
      osc.start();
      osc.stop(audioCtx.currentTime + 0.5);
    }

    function startPlaying() {
      stopPlaying();
      playInterval = setInterval(() => {
        const cells = Array.from(grid.children);
        playhead.style.left = `${playCol * 42}px`;

        for (let row = 0; row < gridSize; row++) {
          const idx = row * gridSize + playCol;
          const noteIdx = gridNotes[idx];
          const noteDiv = cells[idx].querySelector(".note-in-cell");
          noteDiv.classList.remove("note-playing");

          if (noteIdx !== null) {
            const freq = notes[noteIdx].freq;
            playNote(freq);
            noteDiv.classList.add("note-playing");
          }
        }

        setTimeout(() => {
          for (let row = 0; row < gridSize; row++) {
            const idx = row * gridSize + playCol;
            const noteDiv = cells[idx].querySelector(".note-in-cell");
            noteDiv.classList.remove("note-playing");
          }
        }, 300);

        playCol = (playCol + 1) % gridSize;
      }, 400);
    }

    function stopPlaying() {
      clearInterval(playInterval);
      playInterval = null;
      playCol = 0;
      playhead.style.left = `0px`;
    }

    function loadSongs() {
      return JSON.parse(localStorage.getItem("musicgrid_songs") || "{}");
    }

    function saveCurrentSong() {
      if (!currentSongName) return;
      const songs = loadSongs();
      songs[currentSongName] = gridNotes;
      localStorage.setItem("musicgrid_songs", JSON.stringify(songs));
    }

    function refreshSongList() {
      const list = document.getElementById("song-list");
      list.innerHTML = "";
      const songs = loadSongs();
      for (const name in songs) {
        const li = document.createElement("li");
        const btn = document.createElement("button");
        btn.textContent = name;
        btn.addEventListener("click", () => {
          currentSongName = name;
          gridNotes = songs[name].slice();
          updateGridFromNotes();
          document.getElementById("home-screen").style.display = "none";
          document.getElementById("editor-screen").style.display = "flex";
          selectedNoteIndex = null;
          updateSelectedNoteUI();
        });
        li.appendChild(btn);
        list.appendChild(li);
      }
    }

    document.getElementById("new-song-form").addEventListener("submit", e => {
      e.preventDefault();
      const name = document.getElementById("new-song-name").value.trim();
      if (!name) return;
      const songs = loadSongs();
      if (songs[name] && !confirm("Overwrite existing song?")) return;
      currentSongName = name;
      gridNotes = new Array(gridSize * gridSize).fill(null);
      updateGridFromNotes();
      saveCurrentSong();
      document.getElementById("home-screen").style.display = "none";
      document.getElementById("editor-screen").style.display = "flex";
      document.getElementById("new-song-name").value = "";
    });

    deleteToolBtn.addEventListener("click", () => {
      selectedNoteIndex = selectedNoteIndex === "delete" ? null : "delete";
      updateSelectedNoteUI();
    });

    playBtn.addEventListener("click", () => {
      startPlaying();
    });

    stopBtn.addEventListener("click", () => {
      stopPlaying();
    });

    document.getElementById("back-home-btn").addEventListener("click", () => {
      stopPlaying();
      saveCurrentSong();
      currentSongName = null;
      document.getElementById("home-screen").style.display = "flex";
      document.getElementById("editor-screen").style.display = "none";
      refreshSongList();
    });

    createNoteButtons();
    createGrid();
    refreshSongList();
    updateSelectedNoteUI();
  </script>
</body>
</html>
