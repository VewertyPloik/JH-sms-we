<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MusicGrid</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #111;
    color: #eee;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 10px;
    user-select: none;
    min-height: 100vh;
  }
  h1 {
    margin-bottom: 10px;
  }
  #note-selection {
    display: flex;
    flex-wrap: wrap;
    max-width: 1000px;
    margin-bottom: 10px;
  }
  .note-button, #delete-tool {
    width: 30px;
    height: 30px;
    margin: 3px;
    border-radius: 5px;
    cursor: pointer;
    border: 2px solid transparent;
    box-sizing: border-box;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    color: black;
    font-weight: bold;
    background: #eee;
    user-select: none;
  }
  .note-button.selected, #delete-tool.selected {
    border-color: #2ecc71;
  }
  #delete-tool {
    font-size: 14px;
    font-weight: bold;
    background: #eee;
  }
  #grid {
    display: grid;
    grid-template-columns: repeat(18, 50px);
    grid-template-rows: repeat(18, 50px);
    gap: 5px;
    margin-bottom: 20px;
    max-width: 100vw;
    overflow-x: auto;
  }
  .cell {
    background: #222;
    border-radius: 6px;
    border: 1px solid #444;
    position: relative;
    cursor: pointer;
    transition: background-color 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .cell:hover {
    background: #333;
  }
  .note-in-cell {
    width: 30px;
    height: 30px;
    border-radius: 6px;
    transition: transform 0.2s ease, filter 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #111;
    font-weight: bold;
    user-select: none;
  }
  .playing {
    filter: brightness(1.7);
    transform: scale(1.5);
    z-index: 10;
    box-shadow: 0 0 10px #fff;
  }
  #controls {
    margin-bottom: 10px;
  }
  button {
    background: #2ecc71;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    color: #111;
    font-weight: bold;
    cursor: pointer;
    margin: 0 5px;
    transition: background-color 0.3s;
  }
  button:hover {
    background: #27ae60;
  }
  #selected-note-name {
    margin-top: 5px;
    font-size: 18px;
    height: 24px;
  }
  .line {
    position: absolute;
    top: -5px;
    bottom: -5px;
    width: 5px;
    background: #e74c3c;
    border-radius: 3px;
    pointer-events: none;
    transition: left 0.1s linear;
    z-index: 20;
  }
  #grid-container {
    position: relative;
    overflow-x: auto;
    max-width: 100vw;
  }
  /* Home Screen */
  #home-screen {
    width: 100%;
    max-width: 1000px;
    max-height: 80vh;
    overflow-y: auto;
    background: #222;
    padding: 15px;
    border-radius: 10px;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  #song-list {
    width: 100%;
    margin-top: 10px;
  }
  #song-list button {
    width: 100%;
    text-align: left;
    background: #444;
    margin: 5px 0;
    font-size: 18px;
    border-radius: 6px;
    padding: 8px 12px;
  }
  #new-song-form {
    display: flex;
    margin-top: 15px;
    width: 100%;
  }
  #new-song-form input[type="text"] {
    flex-grow: 1;
    padding: 8px;
    border-radius: 6px 0 0 6px;
    border: none;
    font-size: 16px;
  }
  #new-song-form button {
    border-radius: 0 6px 6px 0;
    padding: 8px 15px;
    font-weight: bold;
  }
  #back-home-btn {
    margin-bottom: 10px;
    background: #2980b9;
  }
  #back-home-btn:hover {
    background: #1f6391;
  }
</style>
</head>
<body>

<h1>MusicGrid</h1>

<!-- Home Screen -->
<div id="home-screen">
  <h2>Your Songs</h2>
  <div id="song-list"></div>
  <form id="new-song-form">
    <input type="text" placeholder="New song name" id="new-song-name" required maxlength="30" />
    <button type="submit">Create</button>
  </form>
</div>

<!-- Editor Screen (hidden initially) -->
<div id="editor-screen" style="display:none; flex-direction: column; align-items: center; width: 100%; max-width: 1000px;">
  <button id="back-home-btn">â¬… Back to Songs</button>
  <div id="note-selection"></div>
  <div id="selected-note-name">Select a note</div>
  <div id="grid-container">
    <div id="grid"></div>
    <div id="play-line" class="line" style="display:none;"></div>
  </div>
  <div id="controls">
    <button id="play-btn">Play</button>
    <button id="stop-btn" disabled>Stop</button>
  </div>
</div>

<script>
  // Notes data - 20 notes with colors, names and frequencies (C4 - A6 range)
  const notes = [
    { name: "C4", freq: 261.63, color: "#e74c3c" },
    { name: "D4", freq: 293.66, color: "#e67e22" },
    { name: "E4", freq: 329.63, color: "#f1c40f" },
    { name: "F4", freq: 349.23, color: "#2ecc71" },
    { name: "G4", freq: 392.00, color: "#1abc9c" },
    { name: "A4", freq: 440.00, color: "#3498db" },
    { name: "B4", freq: 493.88, color: "#9b59b6" },
    { name: "C5", freq: 523.25, color: "#34495e" },
    { name: "D5", freq: 587.33, color: "#c0392b" },
    { name: "E5", freq: 659.25, color: "#d35400" },
    { name: "F5", freq: 698.46, color: "#f39c12" },
    { name: "G5", freq: 783.99, color: "#27ae60" },
    { name: "A5", freq: 880.00, color: "#16a085" },
    { name: "B5", freq: 987.77, color: "#2980b9" },
    { name: "C6", freq: 1046.50, color: "#8e44ad" },
    { name: "D6", freq: 1174.66, color: "#2c3e50" },
    { name: "E6", freq: 1318.51, color: "#c0392b" },
    { name: "F6", freq: 1396.91, color: "#d35400" },
    { name: "G6", freq: 1567.98, color: "#f39c12" },
    { name: "A6", freq: 1760.00, color: "#27ae60" },
  ];

  const gridSize = 18; // changed from 8 to 18
  const noteSelection = document.getElementById("note-selection");
  const selectedNoteName = document.getElementById("selected-note-name");
  const grid = document.getElementById("grid");
  const playBtn = document.getElementById("play-btn");
  const stopBtn = document.getElementById("stop-btn");
  const playLine = document.getElementById("play-line");
  const cellSize = 50 + 5; // cell + gap
  const homeScreen = document.getElementById("home-screen");
  const editorScreen = document.getElementById("editor-screen");
  const songListDiv = document.getElementById("song-list");
  const newSongForm = document.getElementById("new-song-form");
  const newSongNameInput = document.getElementById("new-song-name");
  const backHomeBtn = document.getElementById("back-home-btn");

  // Add Delete tool button to note selection
  const deleteToolBtn = document.createElement("div");
  deleteToolBtn.id = "delete-tool";
  deleteToolBtn.textContent = "DEL";
  noteSelection.appendChild(deleteToolBtn);

  let selectedNoteIndex = null; // number or "delete"
  let cells = [];
  let gridNotes = Array(gridSize * gridSize).fill(null); // store note index or null
  let audioCtx = null;
  let isPlaying = false;

  // For smooth play line animation
  let animationFrameId = null;
  let startTime = null;
  const stepDuration = 600; // ms per column
  let lastColumn = -1;

  // Load songs from localStorage
  function loadSongs() {
    const data = localStorage.getItem("musicgrid_songs");
    if (!data) return {};
    try {
      return JSON.parse(data);
    } catch {
      return {};
    }
  }
  // Save songs to localStorage
  function saveSongs(songs) {
    localStorage.setItem("musicgrid_songs", JSON.stringify(songs));
  }

  // Show song list in home screen
  function refreshSongList() {
    const songs = loadSongs();
    songListDiv.innerHTML = "";
    const keys = Object.keys(songs);
    if (keys.length === 0) {
      songListDiv.textContent = "No saved songs yet.";
      return;
    }
    keys.forEach((name) => {
      const btn = document.createElement("button");
      btn.textContent = name;
      btn.title = "Click to load this song";
      btn.addEventListener("click", () => {
        loadSong(name);
      });
      songListDiv.appendChild(btn);
    });
  }

  // Create note buttons for all notes (except Delete tool which was added manually)
  function createNoteButtons() {
    notes.forEach((note, i) => {
      const btn = document.createElement("div");
      btn.classList.add("note-button");
      btn.style.backgroundColor = note.color;
      btn.title = note.name;
      btn.textContent = note.name;
      btn.addEventListener("click", () => {
        selectedNoteIndex = i;
        updateSelectedNoteUI();
      });
      noteSelection.insertBefore(btn, deleteToolBtn);
    });
  }

  // Update green border for selected note or delete tool
  function updateSelectedNoteUI() {
    [...noteSelection.children].forEach((btn) => {
      btn.classList.remove("selected");
    });
    if (selectedNoteIndex === "delete") {
      deleteToolBtn.classList.add("selected");
      selectedNoteName.textContent = "Delete Tool Selected";
    } else if (typeof selectedNoteIndex === "number") {
      noteSelection.children[selectedNoteIndex].classList.add("selected");
      deleteToolBtn.classList.remove("selected");
      selectedNoteName.textContent = `Selected: ${notes[selectedNoteIndex].name}`;
    } else {
      selectedNoteName.textContent = "Select a note";
      deleteToolBtn.classList.remove("selected");
    }
  }

  // Create the 18x18 grid with empty cells
  function createGrid() {
    grid.innerHTML = "";
    cells = [];
    for (let i = 0; i < gridSize * gridSize; i++) {
      const cell = document.createElement("div");
      cell.classList.add("cell");
      cell.dataset.index = i;

      // create note placeholder div
      const noteDiv = document.createElement("div");
      noteDiv.classList.add("note-in-cell");
      cell.appendChild(noteDiv);

      cell.addEventListener("click", () => {
        if (isPlaying) return; // don't edit while playing
        if (selectedNoteIndex === null) return;
        if (selectedNoteIndex === "delete") {
          // remove note if any
          if (gridNotes[i] !== null) {
            gridNotes[i] = null;
            noteDiv.style.backgroundColor = "";
            noteDiv.textContent = "";
          }
        } else {
          if (gridNotes[i] === selectedNoteIndex) {
            // toggle off note if same clicked
            gridNotes[i] = null;
            noteDiv.style.backgroundColor = "";
            noteDiv.textContent = "";
          } else {
            gridNotes[i] = selectedNoteIndex;
            const note = notes[selectedNoteIndex];
            noteDiv.style.backgroundColor = note.color;
            noteDiv.textContent = note.name;
          }
        }
      });

      grid.appendChild(cell);
      cells.push(cell);
    }
  }

  // Play sound helper
  function playNote(freq, duration = 0.3) {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = audioCtx.createOscillator();
    const gainNode = audioCtx.createGain();

    osc.frequency.value = freq;
    osc.type = "sine";
    osc.connect(gainNode);
    gainNode.connect(audioCtx.destination);

    osc.start();
    gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
    osc.stop(audioCtx.currentTime + duration);
  }

  // Visual highlight/unhighlight for playing notes
  function highlightCell(i) {
    const cell = cells[i];
    if (!cell) return;
    const noteDiv = cell.querySelector(".note-in-cell");
    noteDiv.classList.add("playing");
  }
  function unhighlightCell(i) {
    const cell = cells[i];
    if (!cell) return;
    const noteDiv = cell.querySelector(".note-in-cell");
    noteDiv.classList.remove("playing");
  }

  // Smooth play line animation loop
  function playLoop(timestamp) {
    if (!startTime) startTime = timestamp;
    const elapsed = timestamp - startTime;

    // Calculate current column (0 to gridSize-1) based on elapsed time
    let posFloat = (elapsed / stepDuration) % gridSize;
    let currentCol = Math.floor(posFloat);

    // Position playLine smoothly across the grid
    const leftPx = posFloat * (50 + 5);
    playLine.style.left = leftPx + "px";

    // Highlight/unhighlight notes only when we move to a new column
    if (currentCol !== lastColumn) {
      // Unhighlight previous column
      if (lastColumn !== -1) {
        for (let r = 0; r < gridSize; r++) {
          unhighlightCell(r * gridSize + lastColumn);
        }
      }

      // Highlight current column and play notes
      for (let r = 0; r < gridSize; r++) {
        const cellIndex = r * gridSize + currentCol;
        const noteIdx = gridNotes[cellIndex];
        if (noteIdx !== null) {
          highlightCell(cellIndex);
          playNote(notes[noteIdx].freq);
        }
      }
      lastColumn = currentCol;
    }

    if (isPlaying) {
      animationFrameId = requestAnimationFrame(playLoop);
    }
  }

  // Start playback
  function startPlaying() {
    if (isPlaying) return;
    isPlaying = true;
    lastColumn = -1;
    startTime = null;
    playLine.style.display = "block";
    playBtn.disabled = true;
    stopBtn.disabled = false;
    animationFrameId = requestAnimationFrame(playLoop);
  }

  // Stop playback
  function stopPlaying() {
    if (!isPlaying) return;
    isPlaying = false;
    cancelAnimationFrame(animationFrameId);
    animationFrameId = null;
    playLine.style.display = "none";
    lastColumn = -1;
    startTime = null;
    // Clear highlights
    cells.forEach((cell, i) => {
      unhighlightCell(i);
    });
    playBtn.disabled = false;
    stopBtn.disabled = true;
  }

  // Save current song to localStorage
  function saveCurrentSong() {
    if (!currentSongName) return;
    const songs = loadSongs();
    songs[currentSongName] = [...gridNotes]; // clone array
    saveSongs(songs);
  }

  // Load a song by name
  let currentSongName = null;
  function loadSong(name) {
    const songs = loadSongs();
    if (!(name in songs)) {
      alert("Song not found!");
      return;
    }
    currentSongName = name;
    gridNotes = [...songs[name]];
    updateGridFromNotes();
    // Switch UI
    homeScreen.style.display = "none";
    editorScreen.style.display = "flex";
    selectedNoteIndex = null;
    updateSelectedNoteUI();
    stopPlaying();
  }

  // Update grid cells visually from gridNotes array
  function updateGridFromNotes() {
    for (let i = 0; i < gridNotes.length; i++) {
      const noteDiv = cells[i].querySelector(".note-in-cell");
      const noteIdx = gridNotes[i];
      if (noteIdx === null) {
        noteDiv.style.backgroundColor = "";
        noteDiv.textContent = "";
      } else {
        noteDiv.style.backgroundColor = notes[noteIdx].color;
        noteDiv.textContent = notes[noteIdx].name;
      }
    }
  }

  // Clear the grid to empty
  function clearGrid() {
    gridNotes.fill(null);
    updateGridFromNotes();
  }

  // Setup delete tool button event
  deleteToolBtn.addEventListener("click", () => {
    if (selectedNoteIndex === "delete") {
      selectedNoteIndex = null;
    } else {
      selectedNoteIndex = "delete";
    }
    updateSelectedNoteUI();
  });

  // Handle new song form submit
  newSongForm.addEventListener("submit", (e) => {
    e.preventDefault();
    const name = newSongNameInput.value.trim();
    if (!name) return alert("Please enter a song name.");
    const songs = loadSongs();
    if (name in songs) {
      if (!confirm("Song already exists. Overwrite?")) return;
    }
    currentSongName = name;
    clearGrid();
    saveCurrentSong();
    // Switch UI to editor
    homeScreen.style.display = "none";
    editorScreen.style.display = "flex";
    selectedNoteIndex = null;
    updateSelectedNoteUI();
    newSongNameInput.value = "";
  });

  // Back to home screen button
  backHomeBtn.addEventListener("click", () => {
    stopPlaying();
    saveCurrentSong();
    currentSongName = null;
    homeScreen.style.display = "flex";
    editorScreen.style.display = "none";
    refreshSongList();
  });

  // Setup editor UI and grid
  function setupEditor() {
    createNoteButtons();
    createGrid();
    updateSelectedNoteUI();
  }

  // Initialize
  refreshSongList();
  setupEditor();

  // Play/Stop buttons event handlers
  playBtn.addEventListener("click", () => {
    startPlaying();
  });
  stopBtn.addEventListener("click", () => {
    stopPlaying();
  });

</script>

</body>
</html>
